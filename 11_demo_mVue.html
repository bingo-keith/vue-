<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>11_demo_mVue</title>
</head>

<body>
<div id="app">
  <div>{{msg}}</div>
</div>

<script>
class Compile {
  constructor(el, vm) {
    this.$el = el
    this.$vm = vm
  }
}
</script>

<script>
  class MVue {
    constructor(options) {
      // 缓存传入的配置
      this.$options = options
      this.$el = options.el
      this.$data = typeof options.data === 'function' ? options.data() : options.data
      // 监听传入的data数据
      this.observe(this.$data)
      // 编译html文件模版
      new Compile(this.$el)
    }
    observe(obj) {
      if(!obj || typeof obj !== 'object') {
        return false
      }
      Object.keys(obj).forEach(key => {
        this.defineReactive(obj, key, obj[key])
      })
      // 监听数据
      this.defineReactive(obj)
    }
    defineReactive(obj, key, val) {
      console.log(obj)
      // 开始收集依赖了
      const dep = new Dep()
      // 双向数据绑定
      Object.defineProperty(obj, key, {
        get() {
          return val
        },
        set(newVal) {
          val = newVal
          // 通知订阅者更新
          dep.notify()
        }
      })
    }
  }
  class Dep {
    constructor() {
      this.deps = []
    }
    // 添加依赖
    addDep(dep) {
      this.deps.push(dep)
    }
    // 通知订阅者更新
    notify() {
      this.deps.forEach(dep => dep.update())
    }
  }
  class Watcher {
    constructor(vm, key, cb) {
      this.vm = vm
      this.key = key
      this.cb = cb
    }
    // 更新
    update() {

    }
  }
</script>

<script>
  const vm = new MVue({
    el: '#app',
    data() {
      return {
        msg: 'Hello World'
      }
    }
  })
</script>

</body>

</html>
